## Chapter 07. 보안 관련 서비스
### 정보 보안의 3대 요소

- `기밀성` : 정보가 유출되지 않도록 관리하는 것으로, 인가된 사람이나 프로세스/시스템만 시스템에 접근해야 한다는 원칙
- `무결성` : 정보가 손실되지 않고 최신의 상태인 것, 변조 등의 부정조작으로부터 지켜야 한다는 원칙
- `가용성` : 정보를 언제나 사용할 수 있게 하는 것, 데이터를 사용할 수 없는 상태가 되면 즉시 백업된 데이터로 복구해야 함

### 다양한 서비스 결합하여 정보를 보호하는 AWS
- root 사용자 계정은 처음 설정시에만 사용하고, 2FA를 설정해 보안을 강화해야 함
- 사용자별로 권한을 나누고 각 사용자도 반드시 2FA 를 이용하도록 정책 만들어야 함 <br>
    → AWS `IAM` 서비스에서 이러한 설정 (인증, 인가) 관리 가능
- **AWS WAF** : 네트워크 (VPC) 나 응용 프로그램의 침입 방지
- **AWS IAM** : AWS 인증 및 권한 관리
- **AWS GuardDuty** : AWS 계정 전체에 설정하고 관리하는 보안 서비스

### AWS IAM 이란

- **AWS Identity and Access Management (IAM)** : AWS 의 각종 서비스를 사용할 수 있는 사용자를 만들고, 해당 사용자에게 “어떤 서비스의 어떤 기능을 사용할 수 있는지” 와 같은 권한 설정 가능
- `IAM 사용자` 는 IAM 그룹에 추가하여, **해당 그룹이 가진 권한을 사용하게** 할 수도 있음
- `IAM 그룹` 은 **여러 사용자가 동일 권한을 갖도록 관리**해야 할 때 유용하게 사용 가능

### IAM 정책

- AWS 는 수시로 새로운 서비스/기능을 추가하기 때문에 사람이 매번 추가하는 것이 어려움
- 따라서 AWS 에서는 서비스/기능이 추가될 때 자동으로 관련 권한을 추가할 수 있는 **AWS 관리형 정책**을 제공
- 사용자가 만든 IAM 정책은 **고객 관리형 정책**이라고 함

### IAM 역할

- IAM 사용자 생성할 때 액세스 키도 함께 생성 가능한데, 이는 AWS 계정과 동일한 권한을 가지니까 유출될 경우 보안 위협에 노출될 수 있음
- 따라서 IAM 역할로 “사용자에게 권한을 부여하는 게 아니라, **서비스에 해당 서비스를 사용할 수 있는 사용자를 지정**” 하는 것이 안전
- `Role Switch (역할 변경)` : AWS 계정에 `사용자 역할별 IAM 역할`만 생성하고, IAM 사용자가 필요할 때만 역할을 부여해서 적절한 권한으로 작업할 수 있게 설정할 수 있음
    - IAM 사용자 자체에는 조작 권한을 부여하지 않음
    - IAM 사용자는 부여된 IAM 역할이 가진 권한으로 각 계정 조작 가능

### AWS CloudTrail 이란

- AWS 계정 만들때부터 자동으로 모든 작업을 기록하는 서비스
    - AWS 에서 `누가, 어떤 작업을 수행했는지` 자세한 내용 파악 가능
    - 사용자가 악의적 조작하거나, 프로그램 문제로 발생한 설정 변경 조사 가능
- 로그는 기본 90일동안 저장, 설정에 따라 **S3 와 같은 별도 스토리지에 저장 가능**
- S3 에 저장하는 로그 : `트레일` , 암호화되어 보관됨
    - 보관된 로그의 변조 막는 기능 존재
- 관리 콘솔과 API 를 통한 조작 이력만 저장됨
    - 관리 이벤트
        - 관리 콘솔 로그인, AWS 자원의 생성/수정/삭제
    - 데이터 이벤트
        - S3 버킷 관련 작업, 람다함수 실행과 같은 AWS 자원 조작
    - 인사이트 이벤트
        - AWS 계정 이상행동 탐지

### 트레일 출력

- Cloudtrail 은 로그를 추적하여 S3 나 CloudWatch Logs 로 출력 가능
- 출력 로그 무기한 저장
- S3에 저장하는 경우
    - `파일` 형태로 저장 ex) 촬영된 동영상 파일을 대용량 저장소에 저장
    - 저장한 파일의 무결성 검사파일(다이제스트 파일) 출력 가능
- CloudWatch Logs 에 저장하는 경우
    - `스트림` 형태로 저장 ex) 촬영된 영상이 재생되는 형태
    - 로그 내용을 확인하고, 특정 문자열 찾을 때 이벤트 발생시키는 기능 존재하여 특정 조작 발생 시 사용자에게 알림 보낼 수 있음

### 설정 이력을 저장하는 AWS Config

- `AWS Config` : EC2 인스턴스나 보안그룹 같은 AWS 자원에 대한 구성 정보와 변경 이력을 남기는 서비스
    - CloudTrail : 계정의 활동 이력 저장
    - AWS Config : AWS **자원 설정** 내용을 기반으로 이력 저장
- 특히 보안 사고는 설정 변경으로 인해 발생하는 경우가 많아서, 보안 사고가 발생한 시점의 변경 이력을 확인하면 어떤 이유로 사고 발생했는지도 특정 가능

### 설정 확인하는 AWS Config 규칙

- `AWS Config 규칙` : AWS 각 설정이 **규칙을 준수하는지** 확인 가능
    - EBS 가 암호화되어 있는가
    - S3 버킷이 공개적으로 읽고 쓸 수 없는가
- AWS 관리형 규칙 / 사용자 지정 규칙이 있는데, 처음에는 간단히 사용할 수 있는 관리형을 사용하다가 자신만의 규칙으로 최적화 하는 게 좋음
- Config 규칙에서 미준수 자원이 발견됐을 때, EventBridge, Amazon SNS 서비스를 결합해서 메일로 알림 전송도 가능
- `자동 문제 해결` : 미준수 리소스를 자동 수정하는 기능
    - 새로운 규칙 추가하거나 기존 규칙 선택해서 문제해결 작업 선택시 자동으로 문제가 해결됨
    - 자동 수정은 AWS Systems Manager 라는 서비스의 Automation 기능 사용
 
### 지능형 위협 탐지 서비스 Amazon GuardDuty

- AWS 계정 내의 모든 활동을 감시하는 위협 탐지 서비스
- AWS 계정의 보안 상태 즉시 분석 가능
- 탐지 내용 예
    - 루트 사용자 사용
    - IAM 액세스 키가 대량으로 사용됨
    - EC2가 DDos 공격을 위한 좀비 PC가 되었을 가능
- 사용자는 탐지된 내용을 확인하고 대응하면 됨
- CloudTrail, VPC 흐름 로그 및 DNS Logs 의 3가지 정보를 기반으로 탐지 수행
- **기계학습으로 이용 패턴을 학습**해서 탐지
- 어떤 이벤트를 탐지하고, 어떤 동작을 하는지와 같은 구체적인 탐지 정보는 표시되지 않아 확인할 수 없는데, 탐지 내용을 확인하기 위한 `샘플 이벤트` 를 제공함

### 웹 응용 프로그램 보안 강화하기

- `방화벽` : **특정 IP**로부터의 접속이나 서버의 **특정 포트**에 대한 접속을 허가하거나 막을 수 있음
    - 침입으로부터 시스템을 보호하는 역할
    - 인터넷과 서버 사이에 위치해서 **인터넷을 통해 서버로 전송되는 통신을 제어**함
- `웹 방화벽` (Web Application Firewall - WAF) 는 네트워크 방화벽과는 달리 웹 응용 프로그램의 **취약점에 대한 공격을 탐지하고 방어하는 역할**
    - 방화벽과 웹 시스템 사이에 배치
    - 네트워크 방화벽은 `통신 경로에 대한 방어` 를 하는 데 반해 WAF는 `요청에 포함된 공격 코드를 탐지해 방어`
    - IP 와 포트 제한으로는 막을 수 없는 다양한 공격 방어가 가능 (응용 프로그램 계층에서 확인하므로 웹 취약점을 대부분 방어 가능)

### AWS WAF

- `웹 접근 통제 목록 (웹 ACL)` 이라는 자원으로, IP 를 제한하거나 공격 코드를 탐지하는 등 요청에 대한 `제어 규칙` 을 만들고, 이를 보호할 AWS 서비스에 적용
- EC2 에 구축한 웹 시스템이 아니라 ALB 에 WAF 를 적용하면, 해당 ALB 를 사용하는 모든 시스템을 보호할 수 있음
- AWS WAF 는 관리형 서비스이므로 사용자는 WAF 규칙만 설정하면 되고, WAF 규칙은 IP 제한, 간단한 정규표현식 필터링이 가능
    - 관리형 규칙에는 SQL 인젝션 및 크로스 사이트 스크립팅 같은 공격기술에 대한 WAF 규칙도 포함됨
