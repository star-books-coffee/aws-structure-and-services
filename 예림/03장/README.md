# Chapter 3. 컴퓨팅 서비스
## 📌 알아둬야 할 서버 기초 지식

### 대표적인 서버 유형

**웹 서버**

- 웹 사이트를 구성하는 데 필요한 데이터를 저장하고 시스템을 제어하는 프로그램을 설치한 서버
- 웹 서버에는 웹 페이지 자체의 구조를 만드는 HTML 파일과 디자인을 정의하는 CSS 파일, 사이트에 표시되는 이미지 파일 등 서비스 제공에 필요한 데이터가 저장됨.

> 웹 브라우저 = 클라이언트 
웹 사이트 = 웹 서버
> 

**데이터베이스 서버**

- 시스템이 취급하는 데이터를 통합 관리하는 데이터베이스 관리 시스템이 설치된 서버
- 클라이언트에서 특정 데이터를 참조하거나 수정, 삭제 등의 데이터 처리 요구를 요청으로 받아들이고 실행 결과를 응답으로 반환
- EC2에 데이터베이스 관리시스템을 설치해 DB 서버를 설치해 DB 서버를 구축할 수 있지만, AWS 관리형 서비스이면서 튜닝이 쉬운 RDS나 DynomoDB 서비스 중에 선택해 이용할 수 있다.

**메일 서버**

- SMTP 프로토콜, POP3 프로토콜을 이용해 메일 송신, 전달, 수신하는 서버
- 역할에 따라 SMTP 서버와 POP3 서버로 나뉜다.
- SMTP 서버가 시스템에서 자주 사용되므로 이 책에서는 SMTP에 대해 설명한다.
- SMTP 서버 : 메일을 보내는 역할을 하는 서버
- 메일을 보내는 과정
    1. 메일 보내는 사람이 메일 클라이언트 프로그램에서 메일을 작성
    2. SMTP 서버에 메일 전송 요청
    3. 요청을 받은 SMTP 서버가 수신처를 DNS 서버에서 확인해 어디로 메일을 보내야할지 특정
    4. 해당 메일 주소로 메일 전송
- AWS에서는 EC2에 사용자가 메일 서버 구축 가능
    - AWS 관리형 메일 전송 서비스인 Amazon SES 이용

### 웹 서버 작동 방식

- 클라이언트 - 서버 통신 / HTTP 또는 HTTPS 프로토콜로 데이터 주고 받음.
- 웹 서버가 취급하는 데이터
    - 웹 사이트의 콘텐츠 구성을 정의하는 HTML을 중심으로 사이트 자체의 디자인이나 웹 페이지에서 실행되는 프로그램은 서버에 저장되어 있음.
    
    | 카테고리 | 데이터 | 설명 |
    | --- | --- | --- |
    | 사이트 구성 | HTML |  |
    | 사이트 레이아웃 및 디자인 | CSS |  |
    | 스크립트(서버) | PHP, Ruby 등 | 웹 서버에서 처리하는 프로그램, 요청에 따라 처리 결과를 클라이언트에 반환 / 항상 웹 서버에서 처리되므로 결과는 클라이언트 환경에 의존하지 않음. |
    | 스크립트(클라이언트) | JavaScript | 클라이언트(브라우저)에서 실행되는 프로그램 / 클라이언트가 처리하기 때문에 서버에 부하를 주지 않는다. |
    | 이미지 | JPEG, GIF, PNG 등 |  |

### 서버 OS란

- 서버로 이용되는 기기는 주로 `리눅스`나 `윈도우 서버`가 이용된다.

**리눅스**

- 무료 / 오픈소스 소프트웨어 → 누구나 자유롭게 개발, 베포 가능
- 다양한 기업과 단체가 독자적으로 개발한 OS를 `리눅스 배포판(Distribution)`으로 제공하고 있음.
- 대표적인 리눅스 배포판
    
    
    | 배포판 이름 | 설명 |
    | --- | --- |
    | Ret Hat Enterprise Linux | 대규모 시스템 등의 서버에서 많이 이용 / 패키지 관리 시스템으로 RPM 이용 |
    | CentOS | RHEL의 복제 OS / RHEL의 사용 부분을 제거한 배포판 |
    | Debian GNU / Linux | 패키지 관리 시스템으로 deb 이용 |
    | Ubuntu Linux | Debian 기반으로 만들어진 배포판 / 주로 개인 용도로 많이 사용 |

**윈도우 서버**

- 마이크로소프트에서 출시한 서버용 OS
- 리눅스와 달리 OS 자체의 라이선스와 CAL로 불리는 서버 이용 라이선스를 구매해야 함.
- 특징
    - ⭐️ GUI로 조작하며 일반적으로 사용되는 데스크톱 윈도우와 사용법이 비슷함.
        
        ⇒ CUI로 조작하는 리눅스 배포판에 비해 사용이 편함.
        
    - 다른 마이크로소프트 제품과의 연계성 굿
    - AD(Active Directory)와의 연계, 충실한 지원 등

### 서버 가상화

일반적으로 1대의 기기는 1개의 OS만 설치되지만 가상화 소프트웨어를 이용하면 하나의 하드웨어에 여러 OS 동작 가능 ⇒ `서버의 가상화`

> **비유하기**
> 
> - 물리 서버 = 단독 주택
> - 가상 서버 = 아파트
> - 하드웨어 = 건물
> - OS = 가족
- 단독 주택의 경우 그 건물에 사는 가족이 한 가족 뿐임.
- 아파트는 건물 내 여러 집이 존재하고 한 집에는 한 가족이 살 수 있으므로 한 건물에 여러 가족이 살 수 있음.
- 가상 서버는 하나의 하드웨어에서 여러 OS 이용 가능
    - 하드웨어 안에서 방을 나눠 방마다 OS 가동
- 가상화를 수행하는 서버는 가족별로 방의 크기=CPU나 메모리 같은 컴퓨팅 자원의 규모를 결정해야 함. 실제 서버의 경우 OS 종류와 실행할 소프트웨어에 맞춰 자원 할당을 고려해야 함.
- 전체적으로 얼마나 가족이 살수 있는지는 건물의 크기(실제 하드웨어 자원)에 따라 결정

### AWS에서의 가상화

Amazon Elastic Computer Cloud(EC2)

## 📌 EC2 가상 서버를 손쉽게 생성

### EC2란

- 온프레미스랑 무엇이 다를까?
    - 온프레미스 : 하드웨어부터 OS 설치까지 사용자가 해야 함.
    - EC2 :
        - 가상머신을 생성할 때 OS도 함께 설치
        - CPU나 메모리 같은 서버의 사양도 자유롭게 선택 가능
        - 스토리지 용량 변경 가능
        
        ⇒ 부담 없이 서버 생성해 테스트 가능
        
- EC2는 가상서버를 `인스턴스` 단위로 관리한다.
    - 인스턴스 유형 == 가상 서버 사양

### 가상 서버 생성

- 설정해야 하는 것
    - AMI (Amazon 머신 이미지)
    - 인스턴스 사양(인스턴스 유형)
    - 배포할 네트워크
    - 데이터를 저장할 스토리지 용량
    - 사용 권한 설정(보안 그룹)
- 순서
    1. `AMI` 설정 : OS와 소프트웨어가 설정된 템플릿
    2. `인스턴스 유형` 설정 : 가상서버의 성능 결정 
    3. `네트워크` 설정 : 사용자가 생성한 VPC를 선택
    4. `EBS` 설정 : 스토리지 용량(EBS) 설정
    5. `보안그룹` 선택
- 인스턴스 연결하는 방법
    - 리눅스 → SSH / 윈도우 → 원격 데스크톱 등 관리 시스템
    - AWS Systems manager 사용 : EC2 인스턴스를 관리하는 서비스

### 인스턴스 유형으로 서버 성능 결정

- 인스턴스 유형 이름 규칙

- ex) m6g.medium
    - m (`패밀리`): 메모리와 CPU 중 어느 것을 우선시 하느냐와 같이 인스턴스의 특징에 따른 문자열
        - T 유형 인스턴스의 경우, 베이스라인(Baseline)이라는 정해진 CPU 사용률이 정의돼 있으며 정의된 사용률을 초과해서(버스트) 이용할 수도 있다.
        - 다만 일정량을 넘으면 베이스라인 이하의 성능이 되거나 추가 요금 발생
        - 서비스 환경과 같이 상시 사용이 예상되는 환경에서는 M 유형 추천
    - 6 (`세대`) : 숫자가 클수록 성능이 좋다.
    - g (`추가 기능`) : Graviton2(CPU 이름)은 g, 네트워크 강화는 n. 추가기능 문자가 없는 유형도 있음.
    - medium (`크기`) : 크기가 클수록 고성능. 가격도 크기에 따라 높아진다.

### 다양한 EC2 요금제

- 온디맨트 인스턴스 : 일반적으로 사용하는 EC2 인스턴스
- 예약 인스턴스 : 1년 또는 3년간 요금을 선불로 지불하고 이용 (온디맨드 같은 기간동안 이용할 경우보다 최대 72% 할인!!!)
- 절감형 플랜 : 예약 인스턴스와 마찬가지로 기간 약정 조건이지만 다양한 서비스를 운영할 때 유리
    - 여러 패밀리와 크기를 할당해 구매할 수 있음.
- 스팟 인스턴스 : AWS에서 이용하지 않는 자원을 활용해 인스턴스 생성 (최대 90% 할인)
    - AWS 측에서 정지할 수도 있으므로 정지가 허용되는 곳에서 활용 가능

### 그 밖의 EC2 관련 요금

- 네트워크 외부로의 데이터 통신, 데이터를 저장하는 스토리지(EBS)에서 자잘한 요금 발생

- EC2는 AWS의 대규모 서버에서 가상화를 수행
- 사용자는 사용 용도에 따라 OS의 종류나 CPU, 메모리 크기를 자유롭게 선택해 `인스턴스`(가상 서버)를 생성할 수 있음.

> AWS가 보유한 대규모 서버에 여러 사용자의 EC2 인스턴스가 함께 존재한다.

## 📌 가상 서버를 안전하게 외부에 공개

### 서버 외부 공개

EC2를 인터넷에 공개하려면 다음 3가지 조건을 충족해야 한다. 

- EC2를 퍼블릭 서브넷에 배치
- 퍼블릭 IP 주소를 EC2에 부여
- 보안그룹에서 외부로부터의 접근을 허가

### 서버 접근 제어

어느 곳에서 어느 곳으로 접속을 허가할지에 대한 접근제어는 `보안그룹`을 이용한다. 

보안그룹은 온프레미스의 `방화벽` 기능을 수행한다.

- 외부에서 EC2로의 통신을 인바운드 규칙으로 정의하고
- EC2에서 외부로의 통신을 아웃바운드 규칙으로 정의하며
- 둘 다 통신을 허용할 네트워크와 포트 번호를 지정한다.

> 인바운드 규칙의 ‘소스’는 출발지를 의미.
> 

> 아웃바운드 규칙의 기본 설정은 외부로의 모든 트래픽(통신) 허용
> 
- **보안 그룹에 규칙을 추가할 때 대상에 IP가 아니라 보안 그룹 지정도 가능**
    - EC2-A 인스턴스와 EC2-B 인스턴스가 있고, EC2-A에서 EC2-B로 통신을 허가해야 하는 경우 EC2-B 보안그룹에 EC2-A 보안그룹 ID를 지정하면 EC2-A의 IP가 지정돼 통신이 허가 된다.
    - EC2의 IP를 직접 입력하는 것보다 안전하다. 그룹 ID는 변경되지 않기 때문이다.
- 보안 그룹의 특징
    - 보안그룹에 지정하는 규칙은 허용만 할 수 있다는 특징이 있다.
    - 특정 네트워크로부터의 통신을 차단하도록 설정할 수는 없다.
- 주의할 점
    - 보안그룹은 용도마다 따로 생성하고 키-값에 별칭을 잘 입력해 실수하는 일이 없게 하는 것이 좋음.
    - 불필요한 보안그룹은 바로 삭제해야함.

      
## 📌 부하에 따라 서버를 자동으로 추가 / 삭제

Auto Scaling 기능을 사용하면 서버 추가 및 제거를 부하 상황에 맞게 자동으로 수행할 수 있다.

- 서버를 추가하는 것을 `스케일 아웃(Scale-out)`, 제거하는 것을 `스케일 인(Scale-in)`이라 한다.
- CPU 사용률에 맞춰 서버를 추가하거나 CPU를 추가할 수 있다.
- 목표 사용률을 지정해 지정한 값을 유지하게끔 인스턴스 수를 자동으로 조절하는 `대상 추적 조정 정책` 이라는 기능도 있음(무료)
    - 예를 들어 다음과 같이 인스턴스 추가 규칙을 지정할 수 있다.
        - CPU 사용률 > 50% ⇒ 1대 추가
        - CPU 사용률 > 75% ⇒ 다시 1대(총2대) 추가
        - 삭제 규칙도 설정 가능
    - 예를 들어 다음과 같이 CPU 사용률 추적 규칙을 지정할 수 있다.
        - CPU 사용률이 25% 이하가 되게 조정
        - 25% 초과시 서버 추가 / 25% 이하로 떨어지면 서버 삭제
- 서버 자원의 부하가 아닌 **사용자 접속 수**와 같은 기준을 이용한 자동 추가 및 삭제 설정 가능
- 일정을 세워 인스턴스 수 조절하는 `스케줄 스케일`이라는 설정도 가능
- 장애 대비용으로도 사용
    - 지정된 인스턴스 수를 유지하는 기능이 있어 예기치 못한 장애가 발생해 인스턴스가 멈췄다면 자동으로 인스턴스가 새로 만들어짐.
- 그 밖의 것 : 예측 스케일링 기능(서버 수의 수요 예측), 버전관리
- Auto Scaling은 RDS나 ECS 같은 서비스에도 사용 가능

## 📌 서버 없이 프로그램 실행

## 📌 서버리스 활용법 이해

### AWS Lambda는 다른 서비스와 연계해 사용

Lambda 함수는 입력받은 데이터를 처리하기도 하지만 다른 AWS 서비스와 연계해 사용자 접속이나 데이터 연동과 같은 처리를 자동으로 수행할 수도 있다. 

**사용자 요청에 따라 Lambda 함수 실행**

- `API Gateway 서비스` + Lambda
    
    ⇒ 사용자의 HTTP 요청을 Lambda 함수로 처리 가능 (이를 이용해 간단한 웹 응용 프로그램 제작 가능)
    
- API Gateway
    - 사용자로부터 HTTP 요청을 받으면 HTTP 메서드나 JSON 데이터를 람다 람수에 전달
    - 람다 함수에서 응답 내용을 반황하도록 코드를 작성하면 API Gateway를 통해 응답 반환
    - 웹 브라우저라면 웹 브라우저 화면에 응답 데이터 표시됨
- API Gateway도 서버리스

**S3에 데이터를 저장할 때 자동 처리**

- S3에 저장된 데이터를 람다로 자동처리 가능
- 버팃이나 데이터 정보가 JSON 형식으로 람다 함수에 전달되기 때문

**주기적으로 Lambda 함수 실행**

- 주기적으로 정해진 시간에 어떤 처리를 하고 싶다면 `EventBridge`라는 서비스와 Lambda 연계해 구현 가능
- `EventBridge`에 규칙이라는 형태로 매일 실행할 내용 정의해놓고 실행할 대상에 람다 함수 지정

### AWS Lambda 추가 설정 및 모니터링

- 다음 3가지 설정은 사용자가 변경 가능
    - 메모리 용량
    - 타임아웃 시간
    - 환경 변수
- 처음 람다 함수를 만들면 다른 서비스에 대한 조작 권한을 따로 부여해야 함. 람다 함수에 IAM 역할 권항을 부여해여 함
    - 새로 생성된 IAM의 역할에는 CloudWatch라는 감지 서비스로 로그를 보낼 수 있는 권한만 부여됨.

**Lambda 함수 실행 상태 모니터링**

- ClouxWatch에 다음과 같은 정보가 자동으로 전송됨
    - 실행 횟수
    - 실행 시간
    - 오류 수와 실행 성공률

### AWS Lambda 이용 요금

- GB-초 : 메모리 1GB의 함수가 1초 간 실행된 경우의 요금
- 람다애는 프리 티어 존재

## 📌 컨테이너의 구조와 특징 이해

### 컨테이너란

> 최근에는 시스템 아키텍처를 구성할 때 컨테이너를 고려하는 경우도 늘고 있다.
> 
- 컨테이너 vs 서버 가상화
    - 서버 → 집
    - 서버에서 실행되는 응용 프로그램 프로세스 → 집에 사는 거주자
    
    ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/3db2c1d3-d28f-483a-adc8-ee8abc696878/9c6b67f7-deb9-423e-aca6-c25590d62689/Untitled.png)
    
    - 가상 서버는 아파트, 컨테이너는 셰어 하우스
        - 가상 서버 : 하나의 건물에 여러 개의 집이 있음(가상서버1, 가상서버2, …)
        - 컨테이너 : 한 건물 안에 방이 마련돼 여러 사람이 거주 & 가구 등 공동으로 이용 (컨테이너1, 컨테이너2, …) / 컨테이너에서 프로세스가 실행됨.
- `컨테이너 이미지` : 컨테이너가 어떤 응용 프로그램을 실행할지 미리 정의해둔 파일
    - 하나의 컨테이너 이미지로 여러 개의 컨테이너 실행 가능

### 가볍고 빠른 컨테이너

- 컨테이너의 장점(1)  : 가상화에 비해 가볍고 빠르다
- 이유 : **컨테이너 내에 포함된 것이 적음.**
    - 가상 서버의 경우 OS, 미들웨어, 응용 프로그램 등 필요 → 가상 서버 이미지에는 이러한 파일이 모두 포함
    - 컨테이너의 경우 응용 프로그램 프로세스만 시작 → 컨테이너 이미지도 응용 프로그램을 실행하기 위한 의존성 패키지만 포함
- 컨테이너의 장점(2) : 가상화에 비해 빠르게 시작됨.
- 이유 : 가상 서버는 운영체제 시작 후 미들웨어, 응용 프로그램이 실행되는 반면 컨테이너는 직접 응용 프로그램 실행
- **처리 속도 역시 OS에 대한 오버헤드가 없는 만큼 가상서버보다 빠름.**

### 배포의 용이성

- 컨테이너 이미지는 한 번 생성하면 다른 서버에서 바로 사용 가능
    
    ⇒ 개발이 끝난 이미지는 어느 환경에서 사용해도 동일한 동작을 보장
    
    - ↔ 온프레미스나 EC2와 같은 ‘서버’에서라면 개발환경과 상용환경의 의존성 환경을 맞춰야 함 & 개발자의 PC에도 동일 라이브러리를 설치해 동작을 확인해야 함.
- 컨테이너 이미지는 바로 압축 파일 형태로 내보내거나 가져오기 수행 가능
    - 이미지 리포지토리를 이용해 이미지 업로드 및 내려받기도 가능
- 주의할 점: 기본적으로 ‘완성된 이미지’이므로 컨테이너가 종료되면 안에 저장된 내용이 사라짐.
    
    ⇒ 컨테이너가 실행될 호스트 서버의 디렉터리를 마운트해서 작업 내용을 저장하는 등의 처리 필요
    

### 컨테이너 오케스트레이션

- 각 기능을 컨테이너로 분리해 여러 컨테이너를 하나의 시스템처럼 유기적으로 결합해 사용하는 경우가 많음.
- 컨테이너를 모두 따리 관리하려고 하면 관리 부하가 굉장히 높아짐.
    
    ⇒ 컨테이너 오케스트레이션 도구 사용
    
- `컨테이너 오케스트레이션 도구` : 관리를 자동화해 운영 부하를 줄일 수 있음.

## 📌 ECS로 누리는 컨테이너의 장점

### AWS의 컨테이너 오케스트레이션 서비스

- AWS 컨테이너에서 시스템 구축 시 Elastic Container Service(이후 ECS)와 Elastic Kubernetes Service(이후 EKS)라는 두 가지 서비스 중 선택 가능
    - 차이점 : 컨테이너 오케스트레이션 기능을 AWS가 담당하느냐 쿠버네티스가 담당하느냐
- `ECS` : AWS의 관리형 컨테이너 오케스트레이션 서비스
- `Elastic Container Registery(이후 ECR)`이라는 컨테이너 이미지 레지스트리 서비스도 제공 → 사용자 정의된 컨테이너 이미지를 AWS에서 관리 가능 & ECS에 쉽게 배포 가능

### EC2와 Fargate

- 어떤 플랫폼에서 시작할지 선택 가능
    - EC2냐 AWS Fargate냐
- EC2
    - EC2 인스턴스 내에서 실행되는 컨테이너 런타임에서 컨테이너를 실행하는 타입
    - CPU / 메모리 늘리고 싶다면 인스턴스 타입 적절한 것으로 변경
    - 스토리지 늘리고 싶으면 볼륨 크기 확장
- Fargate : AWS에서 관리하는 서버에서 컨테이너 실행
    - CPU / 메모리 직접 할당 가능하지만 메모리 크기 정해짐
    - 스토리지는 사전에 Fargate 태스크 스토리지로 태스크 실행시 할당 (할당량은 PV에 따라 상이)

### Fargate 장점

- 주요 특징 : AWS에서 서버를 관리한다 → 편함
- 요금 : 컨테이너가 이용하는 자원량에 따라 Fargate 전용 요금 지급. 좀 더 비쌈.

### 쿠버네티스를 보다 쉽게 사용할 수 있는 서비스

- 쿠버네티스 : 구글에서 개발한 컨테이너 오케스트레이션 도구
    - k8s로도 표기
- k8s는 직접 구축해 이용하기 위해 필수 구성요소 설치 필요
- BUT EKS를 이용한다면? 이런 문제 해결 가능!
