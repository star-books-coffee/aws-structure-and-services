# Chapter 7. 보안 관련 서비스
## 📌 AWS를 시작하기 위한 첫 걸음

### 정보 보안 3대 요소

- 정보보안의 3대 요소 : 기밀성, 무결성, 가용성
- 기밀성 : 정보가 유출되지 않도록 관리
- 무결성 : 정보가 손상되거나 손실되지 않고 최신의 상태인 것
- 가용성 : 정보를 언제나 사용할 수 있게 하는 것

### 다양한 서비스를 결합해 정보를 보호하는 AWS

- IAM이라는 서비스에서 인증, 인가 관리 가능

## 📌 AWS를 안전하게 사용하기 위한 IAM

### AWS Identity and Access Management란

- IAM : AWS를 사용하는 계정의 권한을 관리하는 서비스
- **AWS 서비스의 조작 제어는 모두 IAM으로 관리**

### IAM 사용자, IAM 그룹

- 사용자가 AWS를 조작하기 위해 사용하는 것이 `IAM 사용자`
- 비밀번호 등의 인증 정보를 사용해 로그인(인증) → IAM 사용자에게 할당된 권한을 사용(인가)
- `액세스 키`라는 인증 정보 발행
- `IAM 그룹`을 만들어 그룹에 권한을 설정
    - 해당 그룹에 IAM 사용자를 추가하면 IAM 사용자는 해당 그룹에 설정된 권한 사용 가능
    - 여러 사용자가 동일한 권한을 갖도록 관리해야 할 때 유용

### IAM 정책

- 어떤 서비스의 기능에 어떤 조작을 할 수 있는지와 같은 권한은 `IAM 정책`을 통해 설정 가능
- 권한 설정을 묶어 이름을 붙여 정의 가능 → 재사용 가능
- 단일 IAM 사용자, IAM 그룹이나 IAM 역할에 여러 IAM 정책 연결 가능
- AWS 관리형 정책 제공 : 서비스나 기능능이 추가될 때 자동으로 관련 권한 추가
    - ‘모든 서비스 이용 가능’
    - ‘모든 서비스 참조만 가능’
    - ‘S3의 모든 기능 사용 가능’
    - 등등
- 보다 강력한 정책을 원할 때 → `고객 관리형 정책`
    - 사용자가 직접 만든 IAM 정책

### IAM 역할

- IAM 사용자를 생성할 때 액세스 키도 함께 생성
- `액세스 키` : CLI로 AWS 자원을 조작하거나 프로그램을 통한 제어를 할 때 사용하는 인증 정보
    - ex) Lambda에서 EC2를 실행하는 조작을 해야 할 때 : Lambda 프로그램에서 액세스 키를 이용해 AWS 계정의 권한을 위임 받아 EC2 실행
- 액세스키는 고정 문자열이며, AWS 계정과 동일한 권한을 가지고 있음 → 보안 위협
- AWS 서비스에 권한을 부여할 때는 `IAM 역할`을 사용하는 것이 좋음
    - 조직의 AWS 리소스에 대한 권한이 없는 사용자나 서비스에 액세스 권한 위임 가능
    - 사용자에게 권한을 부여하는 게 아니라 ‘서비스’에 해당 서비스를 사용할 수 있는 ‘사용자’를 지정
- AWS 권장 사항 : 구축하는 시스템별로 AWS 계정 분리할 것을 권장
- `Role Switch(역할 변경)` : 각 AWS 계정에 사용자 역할 별 IAM 역할만 생성하고 IAM 사용자가 필요한 때만 역할을 부여해 적절한 권한으로 작업할 수 있게 설정 가능
    - IAM 사용자 자체에는 조작 권한을 부여하지 않고 부여된 IAM 역할이 가진 권한으로 각 계정 조작

## 📌 계정 내 작업 이력 기록

### AWS CloudTrail이란

- AWS Cloud Trail : AWS 계정을 만들 때부터 자동으로 모든 작업을 기록하는 서비스
- 필요성 : 악의적인 조작 파악 및 프로그램 문제로 발생한 설정 변경 등 조사 가능
- 로그 저장 가능 : 로그는 기본적으로 90일동안 저장되지만 그 이상 보관하고 싶은 경우 S3와 같은 별도의 스토리지에 파일로 저장 가능
- `트레일(Trail)` : S3에 저장하는 로그 파일
    - 암호화되어 보관됨
- 로그 변조를 막는 기능도 있음

### 기록되는 내용

- CloudTrail에 저장되는 내용 : 관리 콘솔과 API를 통한 조작 이력
    - 이에 해당되지 않는 조작은 기록되지 않음(ex. 원격 EC2 접속)
- 조작 내용 3가지
    1. 관리 이벤트
        
        관리 콘솔에 로그인, AWS 자원의 생성, 수정, 삭제
        
    2. 데이터 이벤트
        
        S3 버킷 관련 작업, Lambda 함수 실행과 같은 AWS 자원에 대한 조작
        
    3. 인사이트 이벤트
        
        AWS 계정의 행동 탐지(평소와는 다른 조작) (평소 사용 패턴을 학습하고 거기에서 벗어난 조작 패턴 탐지)
        
- 기본으로 (1) 관리 이벤트만 기록하게 설정되어 있고 이외에는 설정 필요 (비용 발생)

### 트레일 출력

- Cloud Trail에는 90일 간의 관리 이벤트만 저장 가능
    - 그 이상을 저장하고 싶다면 S3나 Cloud Watch Log 이용
    - 저장 비용 발생하지만 로그 무기한 저장 가능
- 로그를 추적(trail)해 S3나 CloudWatch Logs로 출력 가능
- S3에 저장하는 경우 : 파일 형태로 저장
    - 파일의 무결성 검사 파일(다이제스트 파일)도 출력 가능
- CloudWatch Logs에 저장 : ‘스트림’ 형태로 저장
    - 스트림 : 로그의 내용이 순차적으로 저장
    - 특정 조작이 발생했을 때 사용자에게 알림 보내기 가능
 
## 📌 설정 내역 및 설정 내용을 자동으로 관리

### 설정 이력을 저장하는 AWS Config

- AWS 자원에 대한 구성 정보와 변경 이력을 남기는 서비스
- 기본적으로 7년치 정보 저장
- CloudTrail과 다르게 AWS 자원의 설정 내용을 기반으로 이력 저장
- 고급 쿼리라는 기능을 이용해 특정 자원 수 확인 가능

### 설정을 확인하는 AWS Config 규칙

- 각 설정이 규칙을 준수하는지 확인 가능
- 규칙 미준수 자원을 발견하면 메일로 알림 발송
- 자동 수정도 가능

## 📌 AWS 작업 내용 감시

### 지능형 위협 탐지 서비스 Amazon GuardDuty

- AWS 계정 내 모든 활동 감시하는 위협 탐지 서비스
- 탐지 내용 예
    - 루트 사용자 사용
    - IAM 액세스 키가 대량으로 사용됨
    - EC2가 DDos 공격을 위한 좀비 PC가 되었을 가능성
- EC2에서 실행되는 응용 프로그램이나 Lambda 함수에서 발생하는 위협 이벤트는 감지할 수 없음
- 기계 학습으로 이용 패턴 학습
- 샘플 이벤트 제공 : 구체적인 탐지 정보를 확인할 때 사용
- 요금이 부과되지만 요금이 높아져 문제가 되는 경우는 없음


## 📌 웹 응용 프로그램 보안 강화

### 웹 응용 프로그램을 보안 위협으로부터 보호

- 방화벽 : 기본적으로인터넷과 서버 사이에 위치해 인터넷을 통해 서버로 전송되는 통신 제어
- `웹 방화벽(WAF)` : 웹 응용 프로그램의 취약점에 대한 공격을 탐지하고 방어
    - 일반적으로 방화벽과 웹 시스템 사이에 배치
    - ↔ 네트워크 방화벽은 통신 경로에 대한 방어를 하는 데 반해 WAF는 요청에 포함된 공격 코드를 탐지해 방어

### 간단하게 적용할 수 있는 AWS WAF

- `AWS WAF` : AWS가 제공하는 관리형 보안 서비스
- 사용 방법 : 웹 접근 통제 목록(웹 ACL)이라는 자원으로 IP를 제한하거나 공격 코드를 탐지하는 등 요청에 대한 제어 규칙을 만들고 이를 보호할 AWS 서비스에 적용
- 사용자는 WAF 규칙만 설정하면 됨
    - IP 제한이나 정규 표현식 필터링 외에도 AWS가 제공하는 관리형 규칙 활용 가능
    - SQL 인젝션 및 크로스 사이트 스크립팅 같은 일반적인 공격 기술에 대한 WAF도 포함
- 실제 처리한 요청 수에 따라 요금이 발생 → 요금 효율이 좋음
- AWS 관리형 규칙만으로 대부분 보안 위협에 대응 가능
    - 좀 더 복잡한 공격에 대해 방어하기 위해서는 서드 파티 도구를 사용해야 함
        
    <img src="https://miro.medium.com/v2/resize:fit:1400/1*sHIYOB4vHsKdtsWlelmlMg.png" width=600>


## 📌 시스템 보안을 강화하는 6가지 서비스

### 클라우드에 요구되는 보안

- EC2 인스턴스는 직접 보안 설정을 할 수 있지만 EC2가 실행되는 컨테이너나 데이터 센터의 물리적 보안에 대해서는 알 수 없다

### AWS Network Firewell

- AWS에 구축하는 시스템은 기본적으로 VPC 안에서 동작
- `AWS Network Firewall(이후 Network Firewall)` : VPC를 통한 통신에 대한 방화벽 역할을 하는 서비스
- 일반적인 방화벽과 같이 IP 주소와 포트번호를 지정해 통신을 허가하거나 거부하는 것 외에도 도메인을 지정하거나 Suricata라는 오픈소스 IPS 호환 규칙을 사용하는 등 유연하게 ㅊ통신 제어 가능
- 대상 규칙을 상태 비보존/상태 보존 관계 없이 적용 가능
    - 보안 그룹 : 상태 보존으로 동작
    - 네트워크 ACL : 상태비보존으로 동작
- 통신을 허가하지만 알림을 발생시키는 형태로도 설정할 수 있음
- 관리형 서비스 & 자동으로 처리량을 확장하기 때문에 가용성 ⬆️

### Amazon Inspector

- EC2는 이용자에게 구성의 자유도가 높은 환경이므로 인스턴스 수가 많아지면 취약점 관리도 그만큼 힘듦
- `Amazon Inspector` : 이런 취약점을 관리하기 위한 서비스
- 평가를 위한 규칙을 기본으로 제공하며 평가 일정을 예약 → 지정한 일시에 자동으로 취약점 평가 수행 가능
    - 버전 취약점 확인하거나 AWS 모범 사례를 만족하는지 등을 확인해 보고서 생성
- 소프트웨어의 버전 취약점과 같이 특정 처리를 자동으로 수행하는 AWS Systems Manager와 결합하면 보안 패치를 자동으로 수행 가능 → 운영 비용 절감

### Amazon Shield

- `AWS Shield` : 별도의 설정 없이 자동으로 적용되는 서비스로, `DDos 공격`으로부터 보호하는 서비스
- AWS 서비스 중 트래픽이나 서비스 이용량에 따라 요금이 발생하는 서비스에 DDos 공격을 받으면 막대한 이용 요금을 지불해야 할 수도 있음
- 최근에는 경제적 손실을 목적으로 DDos 공격을 하는 경우도 있는데, EDos 공격으로 구분하기도 함
- 2가지 플랜이 있음
    - Standard : 무료 / 자동 활성화
    - Advanced : AWS DDos 전문 팀의 지원을 받을 수 있음
        - 상당히 비싸서 대규모 서비스가 아니라면 거의 사용 X

### AWS Security Hub

- `AWS Security Hub` : 전체 AWS 계정에 대한 보안 모범 사례를 확인하는 서비스
- PIC DSS라는 신용카드 정보 보안의 국제 표준 기준과 CIS라는 단체가 정한 AWS 계정의 기본적인 보안 모범 사례인 CIS AWS Foundation Benchmark라는 기준을 준수하는지 확인 가능

### AWS Cognito

- AWS Cognito : 웹 응용 프로그램이나 모바일 앱의 사용자 인증 및 권한 부여를 위한 서비스
- AWS에 구축한 시스템을 이용하는 ‘최종 사용자’를 위한 것으로 IAM과는 다름
- ID와 비밀번호 외에도 SMS나 OTP를 이용한 MFC 인증(다중 인증) 가능
- 전화번호나 메일 주소의 유효성 확인, 분실 시 비밀번호 변경 기능 제공
- 권한 부여 기능 : 인증된 사용자에게 권한을 부여하는 기능
    - 인증된 사용자에게 IAM 역할 권한을 사용하게 할 수도 있음
- 권한을 부여할 때 기본 인증 방법 외에도 페이스북, 트위터, 구글이 제공하는 인증 서비스 사용 가능

!https://digitalcloud.training/wp-content/uploads/2022/01/amazon-cognito-authentication-and-authorization.jpeg

### AWS Directory Service

- 어느정도 규모가 있는 조직이라면 사용자 관리를 위해 `Microsoft의 Active Directory`를 사용하는 경우가 많음
- Active Directory에 조직 구성원 등록 → 사내 시스템 인증에 사용하거나 PC, 프린터 인증에 사용하는 등 내부의 정보 자산 이용을 위해 활용 가능
- AWS Directory Service : AWS가 제공하는 Active Directory 서비스
- 종류 3가지
    - AWS Managed Microsoft AD
    - Simple AD
    - AD Connector
- AWS Directory를 구축해 구성원 관리를 하거나 온프레미스에 구축한 Active Directory를 AWS로 마이그레이션 가능
- Active Directory의 구성원을 IAM 역할과 연결할 수 있음
    
    ⇒ IAM에 사용자 추가를 하지 않고 Active Directory에 구성원을 추가해 AWS 서비스를 사용하게끔 설정 가능

## 📌 손쉽게 시작하는 기계 학습

### 기계 학습이란

- 기계학습의 종류
    - 지도 학습 : 정답지 O
    - 비지도 학습 : 정답지 없는 다수의 데이터 사용
    - 강화 학습 : 정답 X / 보상 개념
- `딥러닝` : 기계학습의 하위 개념으로 학습 과정을 컴퓨터가 여러 번 수행해 자율적으로 학습의 정확성을 높이는 방법

### Amazon SageMaker

- 기계학습을 위한 환경을 제공하는 서비스
- 데이터의 수집이나 학습에 사용할 수 있는 형식으로 변환, 지도 학습 데이터 준비, 학습 실행, 학습 결과를 실 운용 환경에 반영, 기계학습에 사용되는 알고리즘 중 유명한 것을 컨테이너 이미지로 구축

### 기타 기계 학습 서비스

- Amazon Lex : 음성 및 텍스트를 사용해 대화형 인터페이스 구축
- Amazon Polly : 딥러닝을 사용한 TTS(Text to Speech)
- Amazon Transcribe : 딥러닝을 사용한 (Speech To Text)
- Amazon Translate : 딥러닝을 이용한 번역 서비스
- Amazon Rekognition : 사진이나 영상으로부터 얼굴 검색과 같이 특정 내용 검출 가능

## 📌 시스템 자체를 관리하는 서비스 4가지

### 시스템 관리란

- `시스템 관리(운영 관리)` :  응용 프로그램에 문제가 발생했을 때의 대응, 긴급 시스템 패치, 버전 업그레이드 등 시스템이 문제 없이 동작하는지, 보안 위협이 발생하지 않는지 감시하는 모든 행위

### AWS CloudFormation

- AWS 자원을 JSON 또는 YAML 형식 파일(템플릿)으로 관리하고 구축하는 서비스
- 템플릿을 통해 동일한 시스템을 구축하거나 문제가 발생했을 때 쉽게 되돌릴 수 있음 (재현성이 높음)
- 수동으로 설정 변경도 가능

### Amazon CloudWatch

- AWS 서비스의 지표, 로그를 모니터링하고 시각과하는 서비스
- 지표 : AWS 서비스로부터 등록된 데이터의 집합으로 EC2나 RDS 인스턴스의 CPU / 메모리 사용률, S3 접속 수와 같이 서비스의 동작 상태 정보가 포함됨.
- 표준 비표 : 아무것도 설정하지 않아도 자동으로 등록되는 지표
- 맞춤형 지표 : CloudWatch 에이전트라는 소프트웨어나 API를 활용해 자체 데이터 등록 가능하며, 마찬가지로 시각화 가능
- 알림 기능 : 특정 지표의 값이 임곗값을 초과할 때 사용자에게 알리거나 지정된 작업 수행 가능
- 로그 감시 기능(CloudWatch Logs) : 로그를 CloudWatch Logs로 정송해 관리 콘솔에서 로그 확인 가능 & 특정 문자열이 포함된 로그가 출력되면 지정된 동작 수행 가능
- API나 CloudWatch 에이전트를 이용해 다른 시스템의 로그도 등록 가능

### AWS Systems Manager

- EC2를 관리하는 서비스로 리눅스 및 윈도우 서버를 관리하는 기능을 가졌다
- 온프레미스 서버도 관리 가능
- 주요 기능
    - Session Manager : 보안 그룹의 통신 권한 설정 없이 관리 대상 서버에 로그인할 수 있는 기능
    - Inventory : 관리 대상 서버에 설치된 소프트웨어 목록 표시
    - Patch Manager : OS나 미들웨어 패치 적용을 관리하는 기능
    - Parameter Store : 시스템 환경변수로 사용할 수 있는 정보 저장
    - Documents : RunCommand, Automation 및 State Manager에서 실행하기 위한 조작 내용을 저장하는 기능
    - Run Command, Automation, State Manager : Document에 지정된 작업을 수행하는 기능
- 일부 기능은 SSM 에이전트를 설치해야 함
- 많은 서버를 일괄 조작하거나 상태를 확인해야할 떄 필요한 편리한 기능을 갖춤

### Amazon Code 시리즈

- 응용 프로그램의 소스 코드를 관리하는 서비스 그룹
- Code Commit : 소스코드를 관리하는 Git 레포지토리 서비스
- CodeDeploy : 소스코드를 빌드하거나 테스트하는 서비스
- CodePipeline : 소스 코드 업데이트에서 빌드, 배포까지의 흐름을 관리
- CodeStar : 이 모든 것을 템플릿을 통해 일괄 구축할 수 있는 서비스

### 효율적인 관리 서비스 이용

- 업데이트 빈도가 많은 요즘 언제나 새로운 기능을 제공해야 하는 요구를 만족시키려면 관리해야 할 시스템과 작업 빈도가 늘어남
    
    ⇒ 운영의 부담으로 다가올 수 있음
    
- 관리 서비스를 적절히 이용해 운영의 효율성을 UP 해야 함
