# Chapter 6. 데이터베이스 서비스
## 📌 알아둬야 할 데이터베이스 기초 지식

### 데이터의 집합체, 데이터베이스

- DB
- DBMS
- RDB
- NoSQL
    - 키와 값이라는 두 가지 요소를 조합해 키-값 형태로 관리하는 서비스

### SQL로 조작하는 관계형 데이터베이스

- SELECT : 데이터 검색
- INSERT : 데이터 추가
- UPDATE : 데이터 갱신
- DELETE : 데이터 삭제

### 데이터 불일치를 없애기 위한 ACID 특성

- 관계형 데이터베이스의 특징 중 하나 : `ACID`
    - 원자성 (`A`tomicity)
        
        트랜잭션은 모두 실행되거나 실행되지 않아야 한다
        
    - 일관성 (`C`onsistency)
        
        정해진 데이터베이스의 규칙을 만족해야 한다
        
    - 독립성 (`I`solation)
        
        트랜잭션을 단독으로 실행할 때나 동시에 여러 개를 실행할 때 결과가 같아야 한다
        
    - 지속성 (`D`urability)
        
        하드웨어 등의 장애가 있어도 완료된 트랜잭션의 결과는 손실되지 않아야 한다
        
- 데이터베이스에서 수행하는 일련의 처리 : 트랜잭션
- 이 트랜잭션의 단위가 ACID 특정을 가짐
- 예시 : 은행 계좌의 예금 인출
    
    (1) 지정한 금액을 인출
    
    (2) 예금 잔액 데이터 갱신
    
    - (1)의 처리만 되는데 처리가 중단되면 예금은 인출되지만 잔액이 변하지 않으므로 큰 문제가 됨 → (1) (2) 모두 실행하거나 어느 쪽도 실행되지 않게 해야 함.
- 이처럼 데이터나 처리의 불일치가 발생하지 않게 하기 위해 ACID 특성이 사용됨

## 📌 AWS에서 관계형 데이터베이스 사용

### 관계형 데이터베이스 서비스 RDS

- OS나 데이터베이스 엔진 관리는 AWS 측에서 수행
- 종량 과금제
- 데이터베이스 엔진 : 데이터베이스에 대한 데이터 등록, 갱신, 삭제 처리를 관리하는 소프트웨어
    - MySQL, MariaDB, …, Aurora 등
- Aurora : AWS가 클라우드용으로 구축한 DB

### 데이터베이스 성능을 결정하는 인스턴스와 스토리지 유형

- 인스턴스에 따라 성능이 달라짐
- **RDS 인스턴스 유형**
    - 인스턴스 크기를 선택해 성능 결정
    - 인스턴스 크기의 명명 규칙은 다음과 같음
        
        ```cpp
        db.m6g.large
        ```
        
        - db : 고정
        - m : 패밀리 (메모리가 우선인지 범용인지에 따라 지정하는 문자열)
        - 6 : 세대 (숫자가 클수록 새롭고 고성능)
        - 9 : 추가 기능
        - large : 크기
    - 앞의 ‘db’가 고정된 것 제외하고는 EC2와 동일한 규칙
- **스토리지 유형**
    - 데이터를 저장하는 것이 주된 목적인 만큼 스토리지 선정 매우 중요
    - 스토리지 유형
        
        
        | 볼륨 유형 | 개요 |
        | --- | --- |
        | 범용 SSD | 고성능으로 용량에 따라 읽기 / 쓰기 성능 결정 |
        | 프로비저닝 IOPS SSD | 고성능이며 지정한 읽기/쓰기 성능 확보 |
        | 마그네틱 HDD | 저렴한 비용 |

### 가용성 향상을 위한 예비 복제본과 읽기 성능 향상을 위한 읽기 전용 복제본

- 데이터를 처리하는 `프라이머리 인스턴스` 외에 `예비 복제본(Standby replica)`을 다중 AZ에 배포해 가용성 향상 가능
- 고가용성을 예비 복제본으로 구현 ⇒ `다중 AZ 배포` (중단되면 안되는 시스템은 다중 AZ에 배치)
    - `고가용성` : 시스템이 중단되지 않고 작동할 수 있는 능력
- `장애 조치(Fail Over)` : 프라이머리 인스턴스나 AZ에 장애가 발생하면 예비 복제본으로 전환해 데이터 베이스를 계속 이용할 수 있도록 하는 전환
- 프라이머리 인스턴스에 장애가 발생하면 `엔드포인트`의 목적지가 자동으로 예비 복재본으로 전환
- 읽기 전용 레플리카 기능 : 프라이머리 인스턴스에서 복제된 인스턴스로, 읽기 전용으로 사용할 수 있다
    - 읽기 처리를 읽기 전용 복제본에 분산 가능(스케일 아웃)
    - 쓰기 성능 향상 불가
- 예비 복제본은 가용성 향상이 목적이라 일반적으로 처리는 수행하지 않음 → 성능 향상에 도움이 되지는 않음

### RDS 보안 설정과 백업

- **RDS 접근 제어**
    - EC2와 마찬가지로 VPC 내에 생성되므로 최소한 두 개의 서브넷 필요
    - 접근 제어는 EC2와 마찬가지로 보안그룹과 네트워크 ACL에서 설정
    - 일반적으로 응용 프로그램에서 DB 접속하는 경우가 많기 때문에 응용 프로그램에서만 접속할수 있도록 보안 그룹이나 네트워크 ACL로 적절하게 설정해야 함
- **데이터베이스 엔진 업데이트**
    - DB 엔진이 실행되는 OS에 취약점 발생 가능
    - 정기적으로 버전 ‘업그레이드’ 필요
    - 버전 업그레이드는 AWS 측에서 실시하지만 ‘업데이트’ 작업은 `유지 관리 기간`이라는 사용자가 설정한 시간대에 실시
        - 일시적으로 RDS 인스턴스 오프라인 상태가 되므로 사용률이 높은 이용 시간대를 피해야 함
- **데이터 백업**
    - RDS는 **자동 백업 기능**이 있어 사용자가 지정한 일 수만큼 `스냅숏` 자동 유지
    - 스냅숏 취득 처리는 사용자가 지정한 백업 위ㅜㄴ도우의 시간대에 실행
    - 스냅숏 파일은 S3 파일에 저장 → 내구성 높음
    - 스냅숏은 새 RDS 인스턴스를 생성하는 방식으로 복원 가능
    - `특정 시점 복구(PITR)` : 특정 시간을 지정하고 복원 가능(특정 시간으로 되돌리는 용도)
 
### AWS에 최적화된 Aurora 기능

- `Aurora 복제`
    - 일반 RDS는 예비 복제와 읽기 복제를 준비해야 함
    - Aurora 복제는 **1개로 가용성 향상과 읽기 성능 향상 모두 달성 가능**
    - Aurora는 평상시에는 읽기 처리 수행(읽기 성능 향상) / 장애가 발생하면 그 즉시 프라이머리 인스턴스로 전환(페일 오버)
    - 여러 개의 `Aurora 복제`를 생성해 읽기 처리 분산 가능
    - 응용 프로그램에는 `읽기용 엔드 포인트`의 URL을 지정해 각 복제에 분산 처리 가능
        - 응용 프로그램에서는 1개의 데이터베이스에만 접속하는 것처럼 구성
- `스토리지 관리`
    - **스토리지 유형과 용량을 지정할 필요가 없다**
    - 스토리지 관리는 AWS가 수행
- `자체 자동 백업 기능`
    - 보존 기간만큼 **지속해서 차분 데이터를 취득**
    - 보존 기간 내 임의의 시점으로 복원 가능
    - 보존 기간 1~35일 설정 가능 & S3에 저장
    - 스냅숏 기능도 있어 장기간 백업 보존 시 활용 가능
- `그 밖의 다른 고유 기능`
    - 다중 리전에 걸친 글로벌 데이터베이스
    - 두 개의 기본 인스턴스가 있는 멀티 마스터 클러스터
    - 인스턴스 크기 지정이 필요하지 않은 Aurora Serverless
    - S3와 연계한 파일 내보내기, 가져오기 기능

## 📌 키와 값의 조합으로 데이터 관리

### 키-값 데이터베이스란

- `Amazon DynomoDB` : key-value 형 데이터를 저장하는 데이터베이스
- 복잡한 검색은 할 수 없지만 고속으로 데이터 추출 가능

### DynomoDB란

- AWS가 만든 고속 키-값 데이터베이스
- 키-값 데이터베이스는 기본적으로 프라이머리 키로만 검색해 데이터를 가져옴
    - DynomoDB도 내부적으로 프라이머리 키 검색을 쉽게할 수 있게 데이터를 정리해 보존
- 서버리스
    - 사용자는 테이블을 생성할 뿐 테이블 조작 요청은 모두 DynomoDB가 처리 ⇒ 사용자가 서버 관리를 하지 않아도 됨
    - 사용자는 테이블 이름과 프라이머리 키만 지정하면 바로 DynomoDB 이용 가능

### DynomoDB 이용 요금

- 조금 특이한 이용 요금 : 요청을 처리할 양을 예약하고 그 양만큼 요금 부과
- 데이터 보관료 발생
- 처리량은 예약하지 않고 무제한으로 설정 가능
- 처리량은 커패서티 유닛으로 불리며 RCU, WCU로 표기
    - 처리량을 예약하는 방식을 프로비저닝 용량 모드, 예약하지 않는 방식을 온디맨드 용량모드라고 함
    - 요청량 예측 불가한 경우 → 온디맨드가 편리(단, 요청량이 많으면 예상 이상의 요금 발생)

### DynomoDB 보수

- 사용자가 고려해야할 것 : 테이블 구조, 백업 계획과 같은 데이터 유지 보수
- AWS에서는 장애 대비를 위해 DynomoDB 데이터를 이중화하여 저장
- 3개의 AZ에 실시간으로 데이터 복제 → 어느 하나의 AZ에 장애가 발생하더라도 문제 없이 서비스를 이용할 수 있음
- `특정 시점 복구 (PITR)` 기능 존재
    - 지난 35일 내 임의의 시점으로 테이블 데이터를 되돌릴 수 있음
- API를 사용한 조작 외에 관리 콘솔에서도 데이터 표시 및 편집 가능

### DynomoDB 이용 예

- 모바일, 웹, 게임, 광고, IOT와 같이 데이터 교환이 매우 많고 사용자에게 빠른 응답이 필요한 응용 프로그램에 이용

## 📌 데이터 분석을 위한 다량의 데이터 수집

### 분석용 데이터베이스 RedShift

- `Amazon Redshift` : 데이터 분석을 위한 데이터 웨어하우스 서비스
    - 데이터를 쌓아두는 역할
- 다른 리전에 있는 대량의 데이터를 Redshift로 가져와 SQL이나 BI 도구를 이용해 분석 가능
- `열 지향 스토리지 구조`(열 별로 데이터 보존)
- `SQL` 사용
- 두 가지 노드로 구성
    - SQL 연결을 받아들이는 `리더 노드`와 스토리지 및 SQL문을 실행하는 `컴퓨터 노드`
    - 컴퓨터 노드는 여러개 존재 ⇒ 처리를 분산해 고속으로 실행
- `RA3`이라는 노드 유형 사용
    - 캐시(임시) 데이터를 컴퓨팅 노드로 가져오고 실제 데이터는 S3에 보관
    - S3는 Redshift에서 관리 → 사용자는 볼 수 없음
- 읽기에 특화된 데이터베이스
    - `COPY 명령`을 사용해 S3 버킷에서 여러 개의 텍스트 데이터를 병렬로 업로드하는 것을 추천
- S3 외에도 DynamoDB, EC2와 같은 외부 서버로부터 COPY를 사용한 업로드 가능

## 📌 데이터베이스 마이그레이션에 도움이 되는 2가지 서비스

### 데이터베이스 마이그레이션의 중요성

- 데이터베이스 엔진을 옮기는 건 꽤 어렵고 복잡함
- 다운타임(서비스 중단 시간)에도 큰 영향을 미침

### AWS Database Migration Service

- AWS Database Migration Service(이후 `DMS`) : 데이터베이스를 마이그레이션하기 위한 서비스
- 현재의 데이터를 새로운 데이터베이스로 쉽게 데이터를 옮기는 역할
- 데이터 형식을 맞춰 옮겨주거나 마이그레이션 도중에 발생한 원본 데이터 변경 내용도 추적해 반영 가능
- 마이그레이션 완료 후 데이터 검증 기능도 제공

### AWS Schema Conversion Tool

- 스키마 == 데이터베이스 설계도
- 다른 데이터베이스 엔진에 마이그레이션할 때 데이터 자체를 옮기기 전에 먼저 스키마 변환 필요
- 스키마 변환을 위한 도구 : AWS Schema Conversion Tool(이후 SCT)
- AWS가 제공하는 PC용 응용 프로그램
- 마이그레이션 진행 전 SCT를 사용해 스키마 변환에 대한 평가 보고서 확인 가능
- 서로 다른 데이터베이스 엔진으로의 마이그레이션은 SCT와 DMS를 함께 사용
    - SCT로 새로운 데이터 베이스에 저장하기 위한 스키마 생성
    - 필요에 따라 수동으로 스키마 수정
    - 생성한 스키마에 DMS로 데이터를 입력
    - dMS로 데이터가 완전하게 마이그레이션 됐는지 검증
 
## 📌 다양한 데이터베이스를 지원하는 7가지 서비스

### 다양한 데이터베이스 서비스

- RDB 외에 NoSQL도 있음

### Amazon ElastiCache

- 인메모리 데이터 스토어 서비스
- 서버의 주기억 장치에 데이터를 저장
    
    ⇒ 보조 기억 장치에 데이터를 저장하는 것보다 고속으로 데이터 읽기 쓰기 가능
    
- 일반적으로 말하는 ‘캐싱’과 동일하기 때문에 `인 메모리 캐싱`이라고 한다
- 시스템 정지 시 데이터 모두 삭제됨
- `ElasticCache for Memcached` 및 `ElastiCache for Redis`라는 2 가지 서비스 제공

### Amazon MemoryDB

- 데이터의 지속성 확보 및 빠르게 읽기 쓰기 가능
- `Amazon MemoryDB for Redis` 서비스
- 메모리 뿐만 아니라 보조 기억 장치에도 데이터 저장 → 복구 가능

### Amazon DocumentDB

- 문서 지향 데이터 서비스
- JSON 형식으로 보관

### Amazon Neptune

- 그래프 데이터 베이스
- 노드, 엣지, 속성 3가지 요소로 구성

### Amazon Quantum Ledger Database

- QLDB
- 원장 데이터 관리
- 이력 데이터(저널)을 저장하기 위한 데이터 베이스
- 추가된 데이터는 삭제 및 수정 불가
- ex) 은행 거래나 제조 이력 관리, 보험료 청구 처리

### Amazon Managed Blockchain

- 블록체인 네트워크 구축 서비스
- 이력을 연결해 전체의 올바른 이력을 생성
- 일관성 없는 이력은 제외
- 각 데이터(이력)가 사슬처럼 연결돼 저장
- ex) 개인 간의 금융 거래나 무역에서의 수출입 이력 관리

### Amazon Timestream

- 시계열 데이터베이스 제공
- 시간마다 변화하는 값을 순차적으로 기록하기에 적합
- ex) 센서 데이터
